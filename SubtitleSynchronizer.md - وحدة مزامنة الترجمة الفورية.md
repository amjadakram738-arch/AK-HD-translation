# SubtitleSynchronizer.md - وحدة مزامنة الترجمة الفورية

## الهدف
تحديد المسؤوليات والمنطق لوحدة مزامنة الترجمة، والتي تعمل كطبقة نهائية لدمج النص المترجم مع التوقيتات وعرضه على واجهة المستخدم (Overlay) بدقة عالية، مع الالتزام بمتطلب الترجمة الفورية.

## النطاق الوظيفي
1.  **استقبال البيانات:** استقبال النتائج المترجمة (Translation Results) من الخادم الوسيط (Proxy) عبر `Background.js` بشكل مستمر.
2.  **إدارة قائمة الانتظار:** تخزين النتائج المترجمة في قائمة انتظار مؤقتة (Queue) بناءً على التوقيت الزمني.
3.  **المزامنة:** استخدام توقيتات البدء والانتهاء (Timestamps) لتحديد متى يجب عرض النص ومتى يجب إخفاؤه.
4.  **العرض:** إرسال النص المترجم في الوقت المناسب إلى `Content Script` للعرض على الفيديو.

## المسؤوليات
| المسؤولية | الوصف |
| :--- | :--- |
| **دقة التزامن** | ضمان أن يكون التزامن بين النص المترجم والصوت الأصلي في حدود **±100 مللي ثانية**. |
| **إدارة العرض** | إرسال رسالة إلى `Content Script` لبدء عرض النص عند `startTime` وإيقاف العرض عند `endTime`. |
| **التعامل مع النتائج الجزئية** | في حالة النتائج الجزئية (Interim Results) من STT، يجب عرضها كمسودة (Draft) ثم استبدالها بالنتيجة النهائية المترجمة. |
| **التنظيف** | إزالة النصوص القديمة من قائمة الانتظار بعد عرضها. |

## ما لا يقع ضمن مسؤوليته
*   الترجمة أو تحويل الكلام إلى نص (مسؤولية المحركات السحابية).
*   التقاط الصوت (مسؤولية `AudioCaptureManager`).
*   التعامل مع DOM أو إنشاء الأيقونة العائمة (مسؤولية `Content Script`).

## آلية العمل المقترحة (Conceptual Flow)
1.  **الاستقبال:** `Background.js` يستقبل `TranslationResult` (الذي يحتوي على النص المترجم و `startTime` و `endTime`).
2.  **التخزين:** يتم تخزين النتيجة في قائمة انتظار داخل `SubtitleSynchronizer`.
3.  **المراقبة:** تستخدم الوحدة مؤقتاً (Timer) أو حلقة حدث (Event Loop) لمقارنة `startTime` و `endTime` بالوقت الحالي لتشغيل الفيديو (يتم الحصول على وقت الفيديو من `Content Script` عبر رسالة).
4.  **العرض:** عندما يحين الوقت، يتم إرسال رسالة إلى `Content Script` تحتوي على النص المترجم للعرض الفوري.

**ملاحظة هامة:** يجب أن يتم تنفيذ هذه الوحدة داخل `Background.js` أو كجزء من منطق الأعمال في `Service Worker` لضمان استمرارية المزامنة حتى لو تم إغلاق واجهة `Popup`.
