# AudioCaptureManager.md - مدير التقاط الصوت

## الهدف
تحديد المسؤوليات والآلية التقنية لوحدة إدارة التقاط الصوت من تبويب المتصفح النشط، لضمان الحصول على تيار صوتي مستمر وعالي الجودة للمعالجة الفورية.

## النطاق الوظيفي
1.  **اكتشاف الفيديو:** يتلقى إشارة من `Content Script` بوجود فيديو نشط.
2.  **بدء الالتقاط:** يستجيب لحدث النقر على الأيقونة العائمة ببدء عملية التقاط الصوت باستخدام `chrome.tabCapture`.
3.  **معالجة التيار:** تحويل `MediaStream` الملتقط إلى مقاطع صوتية (Audio Chunks) صغيرة وموحدة الحجم.
4.  **الإرسال:** إرسال المقاطع الصوتية بشكل مستمر إلى `Background.js` لتوجيهها إلى الخادم الوسيط (Proxy).
5.  **إدارة دورة الحياة:** إدارة حالة الالتقاط (بدء/إيقاف/خطأ) والتنظيف عند الإيقاف.

## المسؤوليات
| المسؤولية | الوصف |
| :--- | :--- |
| **التحقق من الأذونات** | التأكد من أن الإضافة لديها إذن `tabCapture` وأن المستخدم قد وافق على الالتقاط (يتم ذلك تلقائياً عند استدعاء `chrome.tabCapture`). |
| **إنشاء `AudioContext`** | استخدام `AudioContext` و `ScriptProcessorNode` (أو `AudioWorklet` في المستقبل) لمعالجة تيار الصوت الخام. |
| **تقسيم الصوت (Chunking)** | تقسيم التيار الصوتي إلى مقاطع زمنية قصيرة (مثلاً 100 مللي ثانية) وإرسالها بشكل مستمر. |
| **تنسيق البيانات** | تحويل المقاطع الصوتية إلى تنسيق ثنائي موحد (مثل PCM أو FLAC) قبل الإرسال لتقليل زمن الاستجابة. |

## ما لا يقع ضمن مسؤوليته
*   اكتشاف الفيديو في DOM (مسؤولية `Content Script`).
*   إرسال البيانات إلى الخادم الوسيط (مسؤولية `Background.js`).
*   تحويل الصوت إلى نص أو ترجمته (مسؤولية `STTEngineContract` و `TranslationEngineContract`).
*   عرض الترجمة على الشاشة (مسؤولية `Content Script`).

## القيود التقنية والحلول المقترحة
| القيد التقني | الحل المقترح (التخفيف) |
| :--- | :--- |
| **قيود `chrome.tabCapture`** | يتطلب تفاعل المستخدم (النقر) لبدء الالتقاط. **الحل:** تم ربط بدء الالتقاط مباشرة بحدث النقر على الأيقونة العائمة (تفاعل المستخدم). |
| **استهلاك الموارد** | معالجة الصوت في الوقت الفعلي تستهلك موارد وحدة المعالجة المركزية (CPU). **الحل:** استخدام `AudioWorklet` بدلاً من `ScriptProcessorNode` (عندما يكون متاحاً) لتشغيل معالجة الصوت في خيط منفصل (Separate Thread) لتقليل الحمل على `Service Worker`. |
| **تأخير الإرسال (Latency)** | إرسال المقاطع الصوتية عبر نظام الرسائل في Chrome قد يضيف تأخيراً. **الحل:** الحفاظ على حجم المقاطع الصوتية صغيراً جداً (أقل من 100 مللي ثانية) واستخدام الاتصال الثنائي (Binary Communication) لتقليل حجم البيانات. |
