# ExtensionLifecycle.md - دورة حياة الإضافة وإدارة الجلسة

## الهدف
تحديد دورة حياة الإضافة (Extension Lifecycle) وإدارة الجلسة (Session Management) لضمان تجربة مستخدم سلسة، وتجنب طلب الإذن المتكرر، وفصل المسؤوليات بين المكونات.

## النطاق الوظيفي
1.  **دورة حياة الإضافة:** توضيح تسلسل الأحداث من تثبيت الإضافة حتى إزالتها.
2.  **إدارة الجلسة:** الحفاظ على حالة الترجمة (نشط/متوقف) وإعدادات المستخدم عبر جلسات التصفح.
3.  **تسلسل التفعيل:** توضيح التسلسل الزمني لتفعيل الترجمة (اكتشاف الفيديو -> ظهور الأيقونة -> النقر -> بدء الالتقاط).

## المسؤوليات
| المسؤولية | المكون المسؤول | الوصف |
| :--- | :--- | :--- |
| **اكتشاف الفيديو** | `Content Script` | مراقبة DOM لاكتشاف عناصر `<video>` وإضافة الأيقونة العائمة. |
| **إدارة الأذونات** | `Background.js` | عند أول تفعيل، يطلب إذن `tabCapture`. يتم تخزين حالة الإذن في `chrome.storage.local` لتجنب الطلب المتكرر. |
| **حالة الترجمة** | `Background.js` | تخزين حالة الترجمة لكل تبويب (Tab ID) في ذاكرة `Service Worker` المؤقتة. |
| **التواصل بين المكونات** | `Background.js` | يعمل كمركز توزيع للرسائل بين `Content Script` و `Popup` و `AudioCaptureManager`. |

## تسلسل التفعيل (Activation Flow)

| الخطوة | المكون | الحدث | النتيجة |
| :--- | :--- | :--- | :--- |
| **1. الاكتشاف** | `Content Script` | تحميل الصفحة واكتشاف `<video>` | ظهور الأيقونة العائمة. |
| **2. التفاعل** | المستخدم | النقر على الأيقونة العائمة. | `Content Script` يرسل رسالة `START_TRANSLATION` إلى `Background.js`. |
| **3. الالتقاط** | `Background.js` | يستقبل الرسالة ويستدعي `chrome.tabCapture.capture()`. | يظهر طلب إذن التقاط الصوت (مرة واحدة فقط). |
| **4. المعالجة** | `Background.js` | يبدأ `AudioCaptureManager` في معالجة التيار الصوتي وإرساله إلى Proxy. | تبدأ عملية STT والترجمة. |
| **5. العرض** | `Background.js` | يستقبل النص المترجم ويرسله إلى `Content Script`. | `Content Script` يعرض الترجمة على الشاشة عبر Overlay. |

## إدارة الجلسة (Session Management)
*   **الإعدادات:** يتم تخزين إعدادات المستخدم (اللغة الهدف، محرك الترجمة المفضل) في `chrome.storage.sync` لتبقى متزامنة عبر أجهزة المستخدم.
*   **الأذونات:** يتم تخزين حالة موافقة المستخدم على `tabCapture` في `chrome.storage.local`.
*   **استمرارية الجلسة:** يتم تصميم `Background.js` ليكون قادراً على إعادة بناء حالة الترجمة (إذا كان هناك تيار صوتي نشط) عند إعادة تشغيله (Service Worker Lifecycle).
